
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>ADR: Existing Database Support for StormWeaver - StormWeaver Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#adr-existing-database-support-for-stormweaver" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="StormWeaver Documentation" class="md-header__button md-logo" aria-label="StormWeaver Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            StormWeaver Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ADR: Existing Database Support for StormWeaver
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="StormWeaver Documentation" class="md-nav__button md-logo" aria-label="StormWeaver Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    StormWeaver Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../building/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building from source
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scripting-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scripting architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../randomized-testing-concepts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Randomized testing concepts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scripting-examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scripting examples
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../config-parameters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Config parameters
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lua-cpp-reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lua C++ API reference
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../extensibility-workflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extensibility workflow
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../code-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code architecture
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status" class="md-nav__link">
    <span class="md-ellipsis">
      Status
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#current-limitation" class="md-nav__link">
    <span class="md-ellipsis">
      Current Limitation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-for-existing-database-support" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases for Existing Database Support
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-components" class="md-nav__link">
    <span class="md-ellipsis">
      Core Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-schemadiscovery-class" class="md-nav__link">
    <span class="md-ellipsis">
      1. SchemaDiscovery Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-metadatapopulator-class" class="md-nav__link">
    <span class="md-ellipsis">
      2. MetadataPopulator Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-extended-worker-api" class="md-nav__link">
    <span class="md-ellipsis">
      3. Extended Worker API
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgresql-system-catalog-queries" class="md-nav__link">
    <span class="md-ellipsis">
      PostgreSQL System Catalog Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PostgreSQL System Catalog Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#table-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Table Discovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#column-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Column Discovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Index Discovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primary-key-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Primary Key Discovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#partition-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Partition Discovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-mapping-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Type Mapping Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-and-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration and Usage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration and Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lua-interface-only-configuration-method" class="md-nav__link">
    <span class="md-ellipsis">
      Lua Interface (Only Configuration Method)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-and-fallback" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling and Fallback
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Consequences">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#positive" class="md-nav__link">
    <span class="md-ellipsis">
      Positive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#negative" class="md-nav__link">
    <span class="md-ellipsis">
      Negative
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risks-and-mitigations" class="md-nav__link">
    <span class="md-ellipsis">
      Risks and Mitigations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Risks and Mitigations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#risk-schema-discovery-failures" class="md-nav__link">
    <span class="md-ellipsis">
      Risk: Schema Discovery Failures
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risk-type-mapping-incompatibilities" class="md-nav__link">
    <span class="md-ellipsis">
      Risk: Type Mapping Incompatibilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risk-thread-safety-issues" class="md-nav__link">
    <span class="md-ellipsis">
      Risk: Thread Safety Issues
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risk-schema-discovery-overhead" class="md-nav__link">
    <span class="md-ellipsis">
      Risk: Schema Discovery Overhead
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-core-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Core Infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-worker-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: Worker Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-comprehensive-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Comprehensive Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-documentation-and-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Documentation and Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Unit Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regression-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Regression Tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acceptance-criteria" class="md-nav__link">
    <span class="md-ellipsis">
      Acceptance Criteria
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives-considered" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alternatives Considered">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alternative-1-node-based-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative 1: Node-based Discovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-2-automatic-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative 2: Automatic Discovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-3-configuration-based-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative 3: Configuration-based Discovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Notes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Notes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thread-safety-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Safety Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Observability
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Enhancements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Future Enhancements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-schema-support" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Schema Support
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-database-support" class="md-nav__link">
    <span class="md-ellipsis">
      Cross-Database Support
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selective-schema-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Selective Schema Discovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="adr-existing-database-support-for-stormweaver">ADR: Existing Database Support for StormWeaver</h1>
<h2 id="status">Status</h2>
<p><strong>Proposed</strong> - Ready for implementation</p>
<h2 id="context">Context</h2>
<p>StormWeaver currently assumes it starts with an empty database and builds its metadata from scratch as it creates tables, indexes, and other database objects. This approach works well for stress testing scenarios that start from a clean state, but it limits StormWeaver's ability to test backup/restore scenarios and other operations that require working with existing databases.</p>
<h3 id="current-limitation">Current Limitation</h3>
<ul>
<li>StormWeaver can only work with databases it creates from scratch</li>
<li>No support for connecting to existing databases with pre-existing schema</li>
<li>Cannot test backup/restore workflows that start with populated databases</li>
<li>Limited ability to test database recovery scenarios</li>
</ul>
<h3 id="use-cases-for-existing-database-support">Use Cases for Existing Database Support</h3>
<ol>
<li><strong>Backup/Restore Testing</strong>: Create a database, populate it, backup, restore, and continue testing within the same StormWeaver run</li>
<li><strong>Database Recovery Testing</strong>: Test recovery from various failure scenarios during a single test execution</li>
<li><strong>Schema Migration Testing</strong>: Test schema changes on existing databases within a single test workflow</li>
</ol>
<h2 id="decision">Decision</h2>
<p>We will implement support for initializing StormWeaver's metadata from existing databases by:</p>
<ol>
<li><strong>Adding Schema Discovery</strong>: Query PostgreSQL system catalogs to discover existing schema</li>
<li><strong>Implementing Metadata Population</strong>: Convert discovered schema into StormWeaver's metadata structures</li>
<li><strong>Extending Worker API</strong>: Add <code>discover_existing_schema()</code> method to Worker class for initialization</li>
<li><strong>Maintaining Backwards Compatibility</strong>: Ensure all existing scenarios continue working unchanged</li>
<li><strong>Single-Run Scope</strong>: Feature designed for use within a single StormWeaver execution only</li>
</ol>
<h2 id="architecture">Architecture</h2>
<h3 id="core-components">Core Components</h3>
<h4 id="1-schemadiscovery-class">1. SchemaDiscovery Class</h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SchemaDiscovery</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">SchemaDiscovery</span><span class="p">(</span><span class="n">sql_variant</span><span class="o">::</span><span class="n">LoggedSQL</span><span class="o">*</span><span class="w"> </span><span class="n">connection</span><span class="p">);</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DiscoveredTable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discoverTables</span><span class="p">();</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DiscoveredColumn</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discoverColumns</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">table_name</span><span class="p">);</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DiscoveredIndex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discoverIndexes</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">table_name</span><span class="p">);</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DiscoveredConstraint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discoverConstraints</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">table_name</span><span class="p">);</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DiscoveredPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discoverPartitions</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">table_name</span><span class="p">);</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="k">private</span><span class="o">:</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="n">sql_variant</span><span class="o">::</span><span class="n">LoggedSQL</span><span class="o">*</span><span class="w"> </span><span class="n">connection_</span><span class="p">;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="c1">// SQL queries for system catalog introspection</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="p">};</span>
</span></code></pre></div>
<h4 id="2-metadatapopulator-class">2. MetadataPopulator Class</h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MetadataPopulator</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">MetadataPopulator</span><span class="p">(</span><span class="n">metadata</span><span class="o">::</span><span class="n">Metadata</span><span class="o">&amp;</span><span class="w"> </span><span class="n">metadata</span><span class="p">);</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">populateFromExistingDatabase</span><span class="p">(</span><span class="n">SchemaDiscovery</span><span class="o">&amp;</span><span class="w"> </span><span class="n">discovery</span><span class="p">);</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="k">private</span><span class="o">:</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="n">metadata</span><span class="o">::</span><span class="n">Metadata</span><span class="o">&amp;</span><span class="w"> </span><span class="n">metadata_</span><span class="p">;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="n">metadata</span><span class="o">::</span><span class="n">Table</span><span class="w"> </span><span class="nf">convertCompleteTable</span><span class="p">(</span><span class="n">SchemaDiscovery</span><span class="o">&amp;</span><span class="w"> </span><span class="n">discovery</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">DiscoveredTable</span><span class="o">&amp;</span><span class="w"> </span><span class="n">table</span><span class="p">);</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="n">metadata</span><span class="o">::</span><span class="n">Column</span><span class="w"> </span><span class="nf">convertColumn</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DiscoveredColumn</span><span class="o">&amp;</span><span class="w"> </span><span class="n">discovered</span><span class="p">);</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="n">metadata</span><span class="o">::</span><span class="n">Index</span><span class="w"> </span><span class="nf">convertIndex</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DiscoveredIndex</span><span class="o">&amp;</span><span class="w"> </span><span class="n">discovered</span><span class="p">);</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="n">metadata</span><span class="o">::</span><span class="n">ColumnType</span><span class="w"> </span><span class="nf">mapPostgreSQLType</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pg_type</span><span class="p">);</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="p">};</span>
</span></code></pre></div>
<h4 id="3-extended-worker-api">3. Extended Worker API</h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Worker</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1">// Existing constructor unchanged</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">Worker</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">sql_connector_t</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sql_connector</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">           </span><span class="n">WorkloadParams</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">metadata_ptr</span><span class="w"> </span><span class="n">metadata</span><span class="p">);</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="c1">// Existing methods unchanged</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">create_random_tables</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">generate_initial_data</span><span class="p">();</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="c1">// NEW: Discover and populate metadata from existing database</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">discover_existing_schema</span><span class="p">();</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="k">private</span><span class="o">:</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">discoverAndPopulateSchema</span><span class="p">();</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="c1">// ... existing members</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="postgresql-system-catalog-queries">PostgreSQL System Catalog Queries</h3>
<h4 id="table-discovery">Table Discovery</h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">table_name</span><span class="p">,</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">relkind</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">table_type</span><span class="p">,</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="n">am</span><span class="p">.</span><span class="n">amname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">access_method</span><span class="p">,</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="n">ts</span><span class="p">.</span><span class="n">spcname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tablespace</span><span class="p">,</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">relpartbound</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">is_partition</span><span class="p">,</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">  </span><span class="n">pt</span><span class="p">.</span><span class="n">parttype</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">partition_type</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="k">FROM</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_am</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">am</span><span class="p">.</span><span class="n">oid</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_tablespace</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">reltablespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">.</span><span class="n">oid</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_partition</span><span class="w"> </span><span class="n">pt</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt</span><span class="p">.</span><span class="n">partrelid</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relkind</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relnamespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">nspname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">)</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="column-discovery">Column Discovery</h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">attname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">column_name</span><span class="p">,</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">  </span><span class="n">t</span><span class="p">.</span><span class="n">typname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">data_type</span><span class="p">,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">attlen</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">length</span><span class="p">,</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">atttypmod</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">type_modifier</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">attnotnull</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">not_null</span><span class="p">,</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">attnum</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ordinal_position</span><span class="p">,</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attidentity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;d&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">is_serial</span><span class="p">,</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attgenerated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;stored&#39;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">       </span><span class="k">WHEN</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attgenerated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;v&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;virtual&#39;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">       </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;not_generated&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">generated_type</span><span class="p">,</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">  </span><span class="n">pg_get_expr</span><span class="p">(</span><span class="n">ad</span><span class="p">.</span><span class="n">adbin</span><span class="p">,</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">adrelid</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">default_value</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="k">FROM</span><span class="w"> </span><span class="n">pg_attribute</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">atttypid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">oid</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_attrdef</span><span class="w"> </span><span class="n">ad</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attrelid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">adrelid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">adnum</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attrelid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attnum</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attisdropped</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attnum</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="index-discovery">Index Discovery</h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">  </span><span class="n">i</span><span class="p">.</span><span class="n">relname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">index_name</span><span class="p">,</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">  </span><span class="n">ix</span><span class="p">.</span><span class="n">indisunique</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">is_unique</span><span class="p">,</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span><span class="n">array_agg</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">attname</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ix</span><span class="p">.</span><span class="n">indkey</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">column_names</span><span class="p">,</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span><span class="n">array_agg</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="k">option</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;asc&#39;</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">orderings</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">FROM</span><span class="w"> </span><span class="n">pg_index</span><span class="w"> </span><span class="n">ix</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ix</span><span class="p">.</span><span class="n">indexrelid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">oid</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ix</span><span class="p">.</span><span class="n">indrelid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">oid</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_attribute</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attrelid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ANY</span><span class="p">(</span><span class="n">ix</span><span class="p">.</span><span class="n">indkey</span><span class="p">)</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">unnest</span><span class="p">(</span><span class="n">ix</span><span class="p">.</span><span class="n">indoption</span><span class="p">)</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">ORDINALITY</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">o</span><span class="p">(</span><span class="k">option</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">true</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">ix</span><span class="p">.</span><span class="n">indrelid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">ix</span><span class="p">.</span><span class="n">indisprimary</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span><span class="w"> </span><span class="n">ix</span><span class="p">.</span><span class="n">indisunique</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">relname</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="primary-key-discovery">Primary Key Discovery</h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">attname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">column_name</span><span class="p">,</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">attnum</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ordinal_position</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="k">FROM</span><span class="w"> </span><span class="n">pg_constraint</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_index</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">conindid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">indexrelid</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_attribute</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">indrelid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attrelid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ANY</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">indkey</span><span class="p">)</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">conrelid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">contype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;p&#39;</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">attnum</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="partition-discovery">Partition Discovery</h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">partition_name</span><span class="p">,</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="n">pg_get_expr</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">relpartbound</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">partition_bound</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">FROM</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relispartition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relnamespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">nspname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">)</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="type-mapping-strategy">Type Mapping Strategy</h3>
<p>PostgreSQL to StormWeaver type mapping:
- <code>int4</code>, <code>int8</code>, <code>serial</code>, <code>bigserial</code> → <code>metadata::ColumnType::INT</code>
- <code>char</code>, <code>bpchar</code> → <code>metadata::ColumnType::CHAR</code>
- <code>varchar</code> → <code>metadata::ColumnType::VARCHAR</code>
- <code>text</code> → <code>metadata::ColumnType::TEXT</code>
- <code>float4</code>, <code>float8</code>, <code>numeric</code> → <code>metadata::ColumnType::REAL</code>
- <code>bool</code> → <code>metadata::ColumnType::BOOL</code>
- <code>bytea</code> → <code>metadata::ColumnType::BYTEA</code></p>
<h3 id="configuration-and-usage">Configuration and Usage</h3>
<h4 id="lua-interface-only-configuration-method">Lua Interface (Only Configuration Method)</h4>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">-- New: Existing database mode using Worker initialization</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kr">function</span> <span class="nf">main</span><span class="p">()</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="kd">local</span> <span class="n">node</span> <span class="o">=</span> <span class="n">stormweaver</span><span class="p">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">sql_params</span><span class="p">)</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="c1">-- Create a setup worker to discover existing schema</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="kd">local</span> <span class="n">setup_worker</span> <span class="o">=</span> <span class="n">node</span><span class="p">:</span><span class="n">make_worker</span><span class="p">(</span><span class="s2">&quot;schema_discovery&quot;</span><span class="p">)</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="n">setup_worker</span><span class="p">:</span><span class="n">discover_existing_schema</span><span class="p">()</span>  <span class="c1">-- NEW method</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="c1">-- Continue with normal workload</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="kd">local</span> <span class="n">workload</span> <span class="o">=</span> <span class="n">node</span><span class="p">:</span><span class="n">init_random_workload</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="n">workload</span><span class="p">:</span><span class="n">run</span><span class="p">()</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="kr">end</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="c1">-- Existing scenarios remain unchanged</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="kr">function</span> <span class="nf">main</span><span class="p">()</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    <span class="kd">local</span> <span class="n">node</span> <span class="o">=</span> <span class="n">stormweaver</span><span class="p">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">sql_params</span><span class="p">)</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="kd">local</span> <span class="n">workload</span> <span class="o">=</span> <span class="n">node</span><span class="p">:</span><span class="n">init_random_workload</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="n">workload</span><span class="p">:</span><span class="n">run</span><span class="p">()</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="kr">end</span>
</span></code></pre></div>
<h3 id="error-handling-and-fallback">Error Handling and Fallback</h3>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Worker::discover_existing_schema</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">        </span><span class="n">SchemaDiscovery</span><span class="w"> </span><span class="n">discovery</span><span class="p">(</span><span class="n">sql_conn</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">discovery</span><span class="p">.</span><span class="n">discoverTables</span><span class="p">();</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tables</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">            </span><span class="n">spdlog</span><span class="o">::</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;No existing tables found, metadata remains empty&quot;</span><span class="p">);</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="n">MetadataPopulator</span><span class="w"> </span><span class="n">populator</span><span class="p">(</span><span class="o">*</span><span class="n">metadata</span><span class="p">);</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="n">populator</span><span class="p">.</span><span class="n">populateFromExistingDatabase</span><span class="p">(</span><span class="n">discovery</span><span class="p">);</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">        </span><span class="n">spdlog</span><span class="o">::</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Successfully discovered {} tables from existing database&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tables</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">        </span><span class="n">spdlog</span><span class="o">::</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Failed to discover existing schema: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">        </span><span class="n">spdlog</span><span class="o">::</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Metadata remains empty, workers will create tables as normal&quot;</span><span class="p">);</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="consequences">Consequences</h2>
<h3 id="positive">Positive</h3>
<ol>
<li><strong>Backup/Restore Testing</strong>: Enables comprehensive backup/restore workflow testing</li>
<li><strong>Database Recovery Testing</strong>: Supports testing recovery from various failure scenarios</li>
<li><strong>Backwards Compatibility</strong>: Zero breaking changes to existing scenarios</li>
<li><strong>Flexible Configuration</strong>: Multiple ways to configure existing database mode</li>
<li><strong>Robust Error Handling</strong>: Graceful fallback to empty database mode on failures</li>
<li><strong>Thread Safety</strong>: Leverages existing metadata reservation system for safety</li>
</ol>
<h3 id="negative">Negative</h3>
<ol>
<li><strong>Implementation Complexity</strong>: Adds significant complexity to the codebase</li>
<li><strong>PostgreSQL Dependency</strong>: Queries are PostgreSQL-specific (consistent with current focus)</li>
<li><strong>Maintenance Overhead</strong>: New SQL queries and type mappings to maintain</li>
<li><strong>Testing Complexity</strong>: Requires comprehensive testing of schema discovery logic</li>
<li><strong>Single-Run Limitation</strong>: Cannot persist schema information between StormWeaver runs</li>
</ol>
<h3 id="risks-and-mitigations">Risks and Mitigations</h3>
<h4 id="risk-schema-discovery-failures">Risk: Schema Discovery Failures</h4>
<ul>
<li><strong>Mitigation</strong>: Robust error handling with fallback to empty database mode</li>
<li><strong>Monitoring</strong>: Comprehensive logging of discovery process</li>
</ul>
<h4 id="risk-type-mapping-incompatibilities">Risk: Type Mapping Incompatibilities</h4>
<ul>
<li><strong>Mitigation</strong>: Conservative type mapping with explicit error handling</li>
<li><strong>Testing</strong>: Comprehensive test coverage for all supported PostgreSQL types</li>
</ul>
<h4 id="risk-thread-safety-issues">Risk: Thread Safety Issues</h4>
<ul>
<li><strong>Mitigation</strong>: Use existing metadata reservation system</li>
<li><strong>Testing</strong>: Extensive concurrency testing</li>
</ul>
<h4 id="risk-schema-discovery-overhead">Risk: Schema Discovery Overhead</h4>
<ul>
<li><strong>Mitigation</strong>: Discovery only happens when explicitly called via Worker method</li>
<li><strong>Optimization</strong>: Discovery is one-time operation during initialization phase</li>
</ul>
<h2 id="implementation-plan">Implementation Plan</h2>
<h3 id="phase-1-core-infrastructure">Phase 1: Core Infrastructure</h3>
<ol>
<li>Implement <code>SchemaDiscovery</code> class with PostgreSQL system catalog queries</li>
<li>Implement <code>MetadataPopulator</code> class for type conversion</li>
<li>Add <code>Node::initFromExistingDatabase()</code> method</li>
<li>Implement basic error handling and fallback</li>
</ol>
<h3 id="phase-2-worker-integration">Phase 2: Worker Integration</h3>
<ol>
<li>Add Lua interface for <code>worker:discover_existing_schema()</code></li>
<li>Integrate with existing Worker initialization patterns</li>
<li>Ensure proper metadata sharing between discovery worker and workload workers</li>
</ol>
<h3 id="phase-3-comprehensive-testing">Phase 3: Comprehensive Testing</h3>
<ol>
<li>Unit tests for schema discovery and population</li>
<li>Integration tests with various database schemas</li>
<li>Regression tests for backwards compatibility</li>
<li>Performance benchmarks</li>
</ol>
<h3 id="phase-4-documentation-and-examples">Phase 4: Documentation and Examples</h3>
<ol>
<li>Update documentation with new capabilities</li>
<li>Create example scenarios for backup/restore testing</li>
<li>Add troubleshooting guide for common issues</li>
</ol>
<h2 id="testing-strategy">Testing Strategy</h2>
<h3 id="unit-tests">Unit Tests</h3>
<ul>
<li><code>SchemaDiscovery</code> class with mock database connections</li>
<li><code>MetadataPopulator</code> class with various schema combinations</li>
<li>Type mapping functions for all supported PostgreSQL types</li>
<li>Error handling and fallback scenarios</li>
</ul>
<h3 id="integration-tests">Integration Tests</h3>
<ul>
<li>Real PostgreSQL database with various schema configurations</li>
<li>Backup/restore workflow testing</li>
<li>Concurrent access during schema discovery</li>
<li>Performance impact measurement</li>
</ul>
<h3 id="regression-tests">Regression Tests</h3>
<ul>
<li>All existing scenarios continue working unchanged</li>
<li>Metadata consistency between empty and existing database modes</li>
<li>Thread safety under concurrent load</li>
</ul>
<h2 id="acceptance-criteria">Acceptance Criteria</h2>
<ol>
<li><strong>Functional Requirements</strong></li>
<li>[ ] Can discover existing tables, columns, indexes, and constraints</li>
<li>[ ] Correctly maps PostgreSQL types to StormWeaver types</li>
<li>[ ] Supports partitioned tables and range partitioning</li>
<li>[ ] Handles primary keys and unique constraints</li>
<li>
<p>[ ] Gracefully handles schema discovery failures</p>
</li>
<li>
<p><strong>Non-Functional Requirements</strong></p>
</li>
<li>[ ] Zero breaking changes to existing scenarios</li>
<li>[ ] Thread-safe metadata population</li>
<li>[ ] Comprehensive error handling and logging</li>
<li>[ ] Performance impact &lt; 5% for existing workflows</li>
<li>
<p>[ ] Clear documentation and examples</p>
</li>
<li>
<p><strong>Quality Requirements</strong></p>
</li>
<li>[ ] 95%+ unit test coverage for new code</li>
<li>[ ] All existing tests continue passing</li>
<li>[ ] Performance benchmarks within acceptable limits</li>
<li>[ ] Security review of SQL queries completed</li>
</ol>
<h2 id="alternatives-considered">Alternatives Considered</h2>
<h3 id="alternative-1-node-based-discovery">Alternative 1: Node-based Discovery</h3>
<p>Implement schema discovery as a Node method instead of Worker method.
- <strong>Pros</strong>: Centralized initialization logic
- <strong>Cons</strong>: Breaks existing initialization patterns, requires new API surface</p>
<h3 id="alternative-2-automatic-discovery">Alternative 2: Automatic Discovery</h3>
<p>Automatically detect existing schema on first connection.
- <strong>Pros</strong>: No explicit configuration needed
- <strong>Cons</strong>: Unexpected behavior changes, potential performance impact</p>
<h3 id="alternative-3-configuration-based-discovery">Alternative 3: Configuration-based Discovery</h3>
<p>Use command-line or configuration files to enable discovery.
- <strong>Pros</strong>: External configuration control
- <strong>Cons</strong>: Complicates testing, affects existing test suites</p>
<h2 id="implementation-notes">Implementation Notes</h2>
<h3 id="thread-safety-considerations">Thread Safety Considerations</h3>
<ul>
<li>Schema discovery occurs before workers start, avoiding concurrent access</li>
<li>Metadata population uses existing reservation system for thread safety</li>
<li>Discovery process is atomic - either fully succeeds or falls back to empty mode</li>
</ul>
<h3 id="performance-considerations">Performance Considerations</h3>
<ul>
<li>Schema discovery is one-time cost during initialization</li>
<li>Discovered metadata is cached for duration of test run</li>
<li>Fallback to empty mode has zero performance impact</li>
</ul>
<h3 id="monitoring-and-observability">Monitoring and Observability</h3>
<ul>
<li>Comprehensive logging of discovery process</li>
<li>Metrics for discovery success/failure rates</li>
<li>Performance metrics for discovery duration</li>
<li>Schema complexity metrics (table count, column count, etc.)</li>
</ul>
<h2 id="future-enhancements">Future Enhancements</h2>
<h3 id="multi-schema-support">Multi-Schema Support</h3>
<p>Extend to support multiple PostgreSQL schemas beyond 'public'.</p>
<h3 id="schema-validation">Schema Validation</h3>
<p>Compare discovered schema against expected schema for validation testing.</p>
<h3 id="cross-database-support">Cross-Database Support</h3>
<p>Extend schema discovery to support other database systems (MySQL, Oracle, etc.).</p>
<h3 id="selective-schema-discovery">Selective Schema Discovery</h3>
<p>Allow filtering of specific tables or schema elements during discovery.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/catalogs.html">PostgreSQL System Catalogs Documentation</a></li>
<li><a href="libstormweaver/include/metadata.hpp">StormWeaver Metadata System Documentation</a></li>
<li><a href="CLAUDE.md">StormWeaver Architecture Overview</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.code.annotate"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>